MD_TEST_DIR=md_test_dir
targets=${MD_TEST_DIR}/harness

emit_rules_for_bug() {
    echo "# emit_rules_for_bug $*"
    local bugname="${MD_TEST_DIR}/$1"
    local exename="${MD_TEST_DIR}/$2"
    local static_files="${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db"
    cat <<EOF
${bugname}.interp.so: ${bugname}.cep.c cep_interpreter.o
	gcc -shared -Isli/enforce_crash \$^ -o \$@
${bugname}.fix.c: summary_to_fix ${static_files} ${bugname}.summary.canon4
	./summary_to_fix ${static_files} ${bugname}.fix.c ${bugname}.summary.canon4
${bugname}.fix.so: ${bugname}.fix.c sli/patch_head.h sli/patch_skeleton_jump.c sli/patch_skeleton_common.c
	gcc -Wall -g -shared -fPIC -Isli \$< -o \$@
${bugname}.ced: ${bugname}.summary.canon4  enforce_crash ${static_files}
	./enforce_crash ${static_files} \$@ \$<
${bugname}.cep.c: ${bugname}.ced ced_to_cep ${static_files}
	./ced_to_cep ${exename}.exe ${bugname}.ced ${exename}.types.canon ${exename}.bcg ${exename}.db ${bugname}.cep.c
${bugname}.summary.canon4: canonicalise_crash_summary0 ${bugname}.summary.canon3
	./canonicalise_crash_summary0 ${bugname}.summary.canon3 ${bugname}.summary.canon4
${bugname}.summary.canon3: canonicalise_crash_summary3 ${bugname}.summary.canon2 ${exename}.exe ${exename}.types.canon
	./canonicalise_crash_summary3 ${bugname}.summary.canon2 ${exename}.exe ${exename}.types.canon ${bugname}.summary.canon3
${bugname}.summary.canon2: canonicalise_crash_summary2 ${bugname}.summary.canon0
	./canonicalise_crash_summary2 ${bugname}.summary.canon0 ${bugname}.summary.canon2
${bugname}.summary.canon0: canonicalise_crash_summary0 ${bugname}.summary
	./canonicalise_crash_summary0 ${bugname}.summary ${bugname}.summary.canon0
ALL_MD_TESTS+=${bugname}.interp.so
ALL_MD_TESTS+=${bugname}.fix.so
EOF
    for p in interp.so fix.c fix.so ced summary{,.canon0,.canon2,.canon3,.canon4} cep.c
    do
	echo "clean_files+=${bugname}.${p}"
    done
}

_emit_rules_for_exe() {
    echo "# _emit_rules_for_exe $*"
    local exename="${MD_TEST_DIR}/$1"
    local nr_summaries="$2"

    local static_files="${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db"
    cat <<EOF
${exename}.types: ${exename}.exe ./tests/minimal_direct/build_types_table.sh /local/scratch/sos22/valgrind-ft-stage3/bin/valgrind
	./tests/minimal_direct/build_types_table.sh ./\$<
${exename}.bcg: ${exename}.exe ./tests/minimal_direct/build_call_graph.sh ./tests/minimal_direct/build_types_table.sh /local/scratch/sos22/valgrind-ft-stage3/bin/valgrind
	./tests/minimal_direct/build_call_graph.sh ./\$<
${exename}.types.canon: ${exename}.exe ${exename}.types canonicalise_types_table
	./canonicalise_types_table ${exename}.exe ${exename}.types \$@
${exename}.db: ${exename}.exe ${exename}.types.canon ${exename}.bcg static
	./static ${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db
${exename}.exe: tests/minimal_direct/$1.c
	gcc -O -pthread -Wall -g \$< -o \$@
${exename}.db.timing: ${exename}.exe ${exename}.types.canon ${exename}.bcg static timing
	./timing 10 ${exename}.db.timing ./static ${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db
.PRECIOUS: ${exename}.exe ${exename}.types ${exename}.bcg
EOF
    for i in $(seq 0 $((${nr_summaries} - 1)) )
    do
	cat <<EOF
${exename}~${i}.summary: ${exename}.summaries
	! [ -e $</${nr_summaries} ] && [ -e $</${i} ] && cp \$</${i} \$@
clean_files += ${exename}~${i}.summary
EOF
	emit_rules_for_bug "$1~$i" "$1"
    done

    for p in types bcg types.canon db exe db.timing
    do
	echo "clean_files+=${exename}.${p}"
    done

cat <<EOF
${exename}.build_summary_time: ./timing ${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db ./tests/minimal_direct/build_summary.sh canonicalise_crash_summary0 canonicalise_crash_summary2 canonicalise_crash_summary3 minimal_direct
	./timing 10 ${exename}.build_summary_time ./tests/minimal_direct/build_summary.sh ${exename}
clean_files += ${exename}.build_summary_time
EOF

}

emit_rules_for_exe_segv() {
    local exename="${MD_TEST_DIR}/$1"
    local static_files="${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db"
    cat <<EOF
${exename}.summaries: minimal_direct ${static_files} machines
	rm -rf \$@ crash_summaries induction.log logs generated_patch.c && \\
	mkdir logs && \\
	mkdir crash_summaries && \\
	./minimal_direct ${static_files} && \\
	mv crash_summaries ${exename}.summaries
clean_dirs += ${exename}.summaries
EOF
    _emit_rules_for_exe "$1" "$2"
}

emit_rules_for_exe_assert() {
    local exename="${MD_TEST_DIR}/$1"
    local static_files="${exename}.exe ${exename}.types.canon ${exename}.bcg ${exename}.db"
    cat <<EOF
${exename}.summaries: minimal_direct ${static_files} machines
	rm -rf \$@ crash_summaries induction.log logs generated_patch.c && \\
	mkdir logs && \\
	mkdir crash_summaries && \\
	./minimal_direct ${static_files} assertions && \\
	mv crash_summaries ${exename}.summaries
clean_dirs += ${exename}.summaries
EOF
    _emit_rules_for_exe "$1" "$2"
}

rules() {
    cat <<EOF
${MD_TEST_DIR}:
	mkdir ${MD_TEST_DIR}
machines:
	mkdir machines
clean_dirs += machines
EOF
    for bug in 1 2 3 4 6 7 8
    do
	emit_rules_for_exe_segv bug${bug} 1
    done
    for bug in 9
    do
	emit_rules_for_exe_segv bug${bug} 2
    done
    for bug in 5
    do
	emit_rules_for_exe_assert bug${bug} 2
    done

    # And now the harness
    cat <<EOF
${MD_TEST_DIR}/harness: ./tests/minimal_direct/harness.c
	gcc -g -Wall \$< -o \$@
clean_files += ${MD_TEST_DIR}/harness
EOF

    cat <<EOF
all_md_tests: \$(ALL_MD_TESTS)
EOF
}